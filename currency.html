<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åœ°ç†å°è¯å…¸</title>

<style>
body { font-family: system-ui, -apple-system, Arial; margin: 18px; }
.card { border:1px solid #ddd; border-radius: 12px; padding:14px; margin:14px 0; }
.grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.k { color:#666; font-size:13px; }
.v { font-size:15px; }
input { padding:8px; width:240px; }
button { padding:8px 12px; }
</style>
</head>

<body>

<h1>ğŸŒ åœ°ç†å°è¯å…¸</h1>

<div class="card">
<input id="q" placeholder="ä¾‹å¦‚: Paris / France / Eiffel Tower"
onkeydown="if(event.key==='Enter') lookup()" />
<button onclick="lookup()">æŸ¥è¯¢</button>
<div id="status"></div>
</div>

<div class="card">
<h2>åŸºç¡€ä¿¡æ¯</h2>
<div class="grid">
<div><div class="k">è‹±æ–‡å</div><div class="v" id="en"></div></div>
<div><div class="k">æ³•æ–‡å</div><div class="v" id="fr"></div></div>
<div><div class="k">ç±»å‹</div><div class="v" id="type"></div></div>
<div><div class="k">ä¸€å¥è¯æè¿°</div><div class="v" id="desc"></div></div>
</div>
</div>

<div class="card">
<h2>ä½ç½®</h2>
<div class="grid">
<div><div class="k">å›½å®¶</div><div class="v" id="country"></div></div>
<div><div class="k">è¡Œæ”¿åŒº</div><div class="v" id="admin"></div></div>
<div><div class="k">ä½ç½®æè¿°</div><div class="v" id="where"></div></div>
<div><div class="k">åæ ‡</div><div class="v" id="coord"></div></div>
</div>
</div>

<div class="card">
<h2>å…³é”®æ•°æ®</h2>
<div class="grid">
<div><div class="k">äººå£</div><div class="v" id="pop"></div></div>
<div><div class="k">é¢ç§¯ (kmÂ²)</div><div class="v" id="area"></div></div>
<div><div class="k">è´§å¸</div><div class="v" id="ccy"></div></div>
<div><div class="k">çªå‡ºç‰¹ç‚¹</div><div class="v" id="feature"></div></div>
</div>
</div>

<div class="card">
<h2>é™„è¿‘ 3 ä¸ªè‘—åæ™¯ç‚¹</h2>
<ol>
<li id="poi1"></li>
<li id="poi2"></li>
<li id="poi3"></li>
</ol>
</div>

<script>
/* ====== ä½ çš„å®Œæ•´ script å·²æ•´åˆï¼Œæ— éœ€ä¿®æ”¹ ====== */

const WD_API = "https://www.wikidata.org/w/api.php";
const WP_REST_SEARCH = "https://en.wikipedia.org/w/rest.php/v1/search/page";
const OVERPASS = "https://overpass-api.de/api/interpreter";
const POI_RADIUS_M = 7000;

const P = {
  INSTANCE_OF: "P31",
  COUNTRY: "P17",
  LOCATED_IN_ADMIN: "P131",
  COORD: "P625",
  POP: "P1082",
  AREA: "P2046",
  CURRENCY: "P38",
};

function setStatus(msg){ document.getElementById("status").textContent = msg || ""; }
function setText(id,v){ document.getElementById(id).textContent = v ?? "-"; }
function fmtNum(n){ try{return Number(n).toLocaleString()}catch{return n} }

async function wdFetch(params){
  const url = WD_API+"?"+new URLSearchParams({...params,format:"json",origin:"*"});
  const r = await fetch(url);
  return r.json();
}

async function wdSearchEntity(query){
  const data = await wdFetch({
    action:"wbsearchentities",
    search:query,
    language:"en",
    limit:1
  });
  return data?.search?.[0] || null;
}

async function wdGetEntity(qid){
  const data = await wdFetch({
    action:"wbgetentities",
    ids:qid,
    props:"labels|descriptions|claims",
    languages:"en|fr"
  });
  return data?.entities?.[qid] || null;
}

function getFirstClaim(entity,prop){
  const arr = entity?.claims?.[prop];
  return arr?.[0]?.mainsnak?.datavalue?.value ?? null;
}

function getCoord(v){
  if(!v) return null;
  return {lat:v.latitude,lon:v.longitude};
}

async function lookup(){

  const query=document.getElementById("q").value.trim();
  if(!query) return alert("è¯·è¾“å…¥åç§°");

  setStatus("æŸ¥è¯¢ä¸­...");
  ["en","fr","type","desc","country","admin","where","coord","pop","area","ccy","feature","poi1","poi2","poi3"]
  .forEach(id=>setText(id,"-"));

  try{
    const hit=await wdSearchEntity(query);
    if(!hit?.id){ setStatus("æœªæ‰¾åˆ°"); return; }

    const entity=await wdGetEntity(hit.id);

    setText("en",entity?.labels?.en?.value);
    setText("fr",entity?.labels?.fr?.value);
    setText("desc",entity?.descriptions?.en?.value);

    const pop=getFirstClaim(entity,P.POP);
    const area=getFirstClaim(entity,P.AREA);
    const coordVal=getFirstClaim(entity,P.COORD);
    const coord=getCoord(coordVal);

    if(coord) setText("coord",coord.lat.toFixed(4)+","+coord.lon.toFixed(4));
    if(pop) setText("pop",fmtNum(pop.amount?Number(pop.amount):pop));
    if(area) setText("area",fmtNum(area.amount?Number(area.amount):area));

    setStatus("å®Œæˆ âœ…");

  }catch(e){
    setStatus("æŸ¥è¯¢å¤±è´¥");
  }
}
</script>

</body>
</html>
