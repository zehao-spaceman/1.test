 <script>
  // ---- 公开 API 端点 ----
  const WD_API = "https://www.wikidata.org/w/api.php";
  const WP_REST_SEARCH = "https://en.wikipedia.org/w/rest.php/v1/search/page"; //  [oai_citation:4‡MediaWiki](https://www.mediawiki.org/wiki/API%3AREST_API/Get_started?utm_source=chatgpt.com)
  const OVERPASS = "https://overpass-api.de/api/interpreter"; // Overpass 示例见 OSM Wiki  [oai_citation:5‡OpenStreetMap](https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_API_by_Example?utm_source=chatgpt.com)

  // 你希望“附近景点”搜索半径（米）
  const POI_RADIUS_M = 7000;

  // 主要属性（Wikidata Property IDs）
  const P = {
    INSTANCE_OF: "P31",
    COUNTRY: "P17",
    LOCATED_IN_ADMIN: "P131",
    COORD: "P625",
    POP: "P1082",
    AREA: "P2046",
    CURRENCY: "P38",
  };

  // ---- 小工具：写入 UI ----
  function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }
  function setText(id, v) { document.getElementById(id).textContent = (v ?? "-"); }
  function fmtNum(n) {
    if (n === null || n === undefined) return "-";
    try { return Number(n).toLocaleString(); } catch { return String(n); }
  }

  // ---- fetch JSONP-like: Wikidata 允许 origin=* 跨域 ----
  async function wdFetch(params) {
    const url = WD_API + "?" + new URLSearchParams({ ...params, format: "json", origin: "*" }).toString();
    const r = await fetch(url);
    if (!r.ok) throw new Error("Wikidata HTTP " + r.status);
    return r.json();
  }

  // 1) 用用户输入去 Wikidata 搜实体（拿 QID）
  async function wdSearchEntity(query, lang="en") {
    const data = await wdFetch({
      action: "wbsearchentities",
      search: query,
      language: lang,
      limit: 1
    }); // wbsearchentities 用法  [oai_citation:6‡GitHub](https://github.com/maxlath/wikibase-sdk/blob/main/docs/search_entities.md?utm_source=chatgpt.com)
    return data?.search?.[0] || null;
  }

  // 2) 用 QID 拉实体详情（含声明 statements）
  async function wdGetEntity(qid) {
    const data = await wdFetch({
      action: "wbgetentities",
      ids: qid,
      props: "labels|descriptions|claims|sitelinks",
      languages: "en|fr"
    }); // wbgetentities 端点说明  [oai_citation:7‡MediaWiki](https://www.mediawiki.org/wiki/Wikibase/API?utm_source=chatgpt.com)
    return data?.entities?.[qid] || null;
  }

  // 3) 从 claims 里提取“数值/实体/坐标”
  function getFirstClaim(entity, prop) {
    const arr = entity?.claims?.[prop];
    if (!arr || !arr.length) return null;
    return arr[0]?.mainsnak?.datavalue?.value ?? null;
  }

  async function qidToLabel(qid, lang="en") {
    if (!qid) return null;
    const ent = await wdGetEntity(qid);
    return ent?.labels?.[lang]?.value || ent?.labels?.en?.value || qid;
  }

  function getEntityIdFromValue(v) {
    // v: { "entity-type":"item", "numeric-id": 90, "id":"Q90" }
    return v?.id || null;
  }

  function getCoord(v) {
    // v: { latitude, longitude, ... }
    if (!v || typeof v.latitude !== "number" || typeof v.longitude !== "number") return null;
    return { lat: v.latitude, lon: v.longitude };
  }

  function pickTypeLabelFromInstanceOf(instanceLabel) {
    const s = (instanceLabel || "").toLowerCase();
    if (s.includes("sovereign state") || s === "country") return "国家";
    if (s.includes("city") || s.includes("town")) return "城市";
    if (s.includes("capital")) return "首都/首府";
    if (s.includes("region") || s.includes("province") || s.includes("state")) return "地区/行政区";
    if (s.includes("tourist attraction") || s.includes("monument") || s.includes("museum") || s.includes("building")) return "景点";
    return instanceLabel || "（未识别类型）";
  }

  // 4) Wikipedia：用 REST Search 找到最接近的页面摘要/标题
  async function wpSearchSummary(query) {
    const url = WP_REST_SEARCH + "?" + new URLSearchParams({ q: query, limit: "1" }).toString();
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    const page = j?.pages?.[0];
    if (!page) return null;
    // page.title / page.description / page.excerpt 可能有
    return {
      title: page.title,
      description: page.description || "",
      excerpt: (page.excerpt || "").replace(/<[^>]+>/g, "")
    };
  }

  // 5) Overpass：按坐标找附近景点（旅游点）
  async function fetchNearbyAttractions(lat, lon) {
    // 简化：查 tourism=attraction / museum / viewpoint / monument
    const q = `
      [out:json][timeout:25];
      (
        node(around:${POI_RADIUS_M},${lat},${lon})["tourism"="attraction"];
        node(around:${POI_RADIUS_M},${lat},${lon})["tourism"="museum"];
        node(around:${POI_RADIUS_M},${lat},${lon})["tourism"="viewpoint"];
        node(around:${POI_RADIUS_M},${lat},${lon})["historic"="monument"];
      );
      out tags 30;
    `;
    const r = await fetch(OVERPASS, { method: "POST", body: q, headers: { "Content-Type": "text/plain" } });
    if (!r.ok) return [];
    const j = await r.json();
    const els = j?.elements || [];
    const names = els
      .map(e => e?.tags?.name)
      .filter(Boolean);

    // 去重 + 取前 3
    const uniq = [];
    for (const n of names) {
      if (!uniq.includes(n)) uniq.push(n);
      if (uniq.length >= 3) break;
    }
    return uniq;
  }

  async function lookup() {
    const query = document.getElementById("q").value.trim();
    if (!query) { alert("请输入国家/城市/景点名称"); return; }

    setStatus("查询中…");
    // 先清空
    ["en","fr","type","desc","country","admin","where","coord","pop","area","ccy","feature","poi1","poi2","poi3"]
      .forEach(id => setText(id, "-"));

    try {
      // A) Wikidata 搜实体（优先用英文搜索）
      const hit = await wdSearchEntity(query, "en");
      if (!hit?.id) {
        setStatus("未在 Wikidata 找到匹配条目");
        return;
      }

      const qid = hit.id; // e.g. Q90
      const entity = await wdGetEntity(qid);

      // labels
      const enLabel = entity?.labels?.en?.value || hit.label || query;
      const frLabel = entity?.labels?.fr?.value || "-";
      setText("en", enLabel);
      setText("fr", frLabel);

      // instance of -> type
      const instVal = getFirstClaim(entity, P.INSTANCE_OF);
      const instQid = getEntityIdFromValue(instVal);
      const instLabel = instQid ? await qidToLabel(instQid, "en") : null;
      setText("type", pickTypeLabelFromInstanceOf(instLabel));

      // country
      const countryVal = getFirstClaim(entity, P.COUNTRY);
      const countryQid = getEntityIdFromValue(countryVal);
      const countryLabel = countryQid ? await qidToLabel(countryQid, "en") : "-";
      setText("country", countryLabel);

      // admin (located in the administrative territorial entity)
      const adminVal = getFirstClaim(entity, P.LOCATED_IN_ADMIN);
      const adminQid = getEntityIdFromValue(adminVal);
      const adminLabel = adminQid ? await qidToLabel(adminQid, "en") : "-";
      setText("admin", adminLabel);

      // coord
      const coordVal = getFirstClaim(entity, P.COORD);
      const coord = getCoord(coordVal);
      if (coord) setText("coord", `${coord.lat.toFixed(4)}, ${coord.lon.toFixed(4)}`);

      // population / area / currency
      const popVal = getFirstClaim(entity, P.POP);
      const areaVal = getFirstClaim(entity, P.AREA);
      const curVal = getFirstClaim(entity, P.CURRENCY);
      const curQid = getEntityIdFromValue(curVal);
      const curLabel = curQid ? await qidToLabel(curQid, "en") : "-";

      setText("pop", popVal ? fmtNum(popVal.amount ? Number(popVal.amount) : popVal) : "-");
      setText("area", areaVal ? fmtNum(areaVal.amount ? Number(areaVal.amount) : areaVal) : "-");
      setText("ccy", curLabel);

      // B) Wikipedia：一句话描述（用 REST search 返回的 description/excerpt）
      const wp = await wpSearchSummary(enLabel);
      if (wp) {
        // 优先 description，其次 excerpt
        const summary = (wp.description || wp.excerpt || "").trim();
        setText("desc", summary || (entity?.descriptions?.en?.value ?? "-"));
      } else {
        setText("desc", entity?.descriptions?.en?.value ?? "-");
      }

      // C) 位置描述（简洁）
      if (countryLabel !== "-" && adminLabel !== "-") {
        setText("where", `位于 ${countryLabel}（${adminLabel}）`);
      } else if (countryLabel !== "-") {
        setText("where", `位于 ${countryLabel}`);
      } else {
        setText("where", "-");
      }

      // D) “突出特点”先做简洁规则：从 Wikidata 描述里抓关键词（可后续升级为手动标签）
      const d = (entity?.descriptions?.en?.value || "").toLowerCase();
      let feat = "-";
      if (d.includes("capital")) feat = "政治/行政中心";
      else if (d.includes("tourist") || d.includes("attraction")) feat = "旅游";
      else if (d.includes("financial") || d.includes("finance")) feat = "金融";
      else if (d.includes("agric")) feat = "农业";
      else if (d.includes("industrial") || d.includes("manufact")) feat = "工业";
      setText("feature", feat);

      // E) 附近 3 个景点（需要坐标）
      if (coord) {
        setStatus("查询中…（正在找附近景点）");
        const pois = await fetchNearbyAttractions(coord.lat, coord.lon);
        setText("poi1", pois[0] || "-");
        setText("poi2", pois[1] || "-");
        setText("poi3", pois[2] || "-");
      }

      setStatus("完成 ✅");
    } catch (e) {
      setStatus("查询失败（可能是网络或 API 暂时不可用），请稍后重试。");
    }
  }
</script>
