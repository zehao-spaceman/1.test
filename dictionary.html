<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åœ°ç†å°è¯å…¸</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; margin: 18px; }
    .top { display:flex; justify-content: space-between; align-items:center; gap: 10px; }
    a { text-decoration: none; }
    .card { border:1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .k { color:#666; font-size: 13px; }
    .v { font-size: 15px; line-height: 1.35; }
    input { padding: 10px; width: 260px; max-width: 70vw; }
    button { padding: 10px 12px; }
    .muted { color:#666; font-size: 14px; }
    #status { margin-top: 8px; }
    ol { margin: 8px 0 0 18px; }
  </style>
</head>

<body>
  <div class="top">
    <h1>ğŸŒ åœ°ç†å°è¯å…¸</h1>
    <a href="index.html">â† å›åˆ°é¦–é¡µ</a>
  </div>

  <div class="card">
    <div>
      <input id="q" placeholder="ä¾‹å¦‚: Paris / France / Eiffel Tower"
             onkeydown="if(event.key==='Enter') lookup()" />
      <button onclick="lookup()">æŸ¥è¯¢</button>
    </div>
    <div id="status" class="muted"></div>
    <div class="muted">æç¤ºï¼šæœ‰äº›æ¡ç›®å¯èƒ½æ²¡æœ‰äººå£/é¢ç§¯/è´§å¸ï¼ˆWikidata æ¡ç›®æœ¬èº«æœªå¡«ï¼‰ã€‚</div>
  </div>

  <div class="card">
    <h2>åŸºç¡€ä¿¡æ¯</h2>
    <div class="grid">
      <div><div class="k">è‹±æ–‡å</div><div class="v" id="en">-</div></div>
      <div><div class="k">æ³•æ–‡å</div><div class="v" id="fr">-</div></div>
      <div><div class="k">ç±»å‹</div><div class="v" id="type">-</div></div>
      <div><div class="k">ä¸€å¥è¯æè¿°</div><div class="v" id="desc">-</div></div>
    </div>
  </div>

  <div class="card">
    <h2>ä½ç½®ä¸å±‚çº§</h2>
    <div class="grid">
      <div><div class="k">å›½å®¶</div><div class="v" id="country">-</div></div>
      <div><div class="k">è¡Œæ”¿åŒº/ä¸Šçº§åŒºåŸŸ</div><div class="v" id="admin">-</div></div>
      <div><div class="k">ä½ç½®æè¿°</div><div class="v" id="where">-</div></div>
      <div><div class="k">åæ ‡</div><div class="v" id="coord">-</div></div>
    </div>
  </div>

  <div class="card">
    <h2>å…³é”®æ•°æ®</h2>
    <div class="grid">
      <div><div class="k">äººå£</div><div class="v" id="pop">-</div></div>
      <div><div class="k">é¢ç§¯ï¼ˆkmÂ²ï¼‰</div><div class="v" id="area">-</div></div>
      <div><div class="k">è´§å¸</div><div class="v" id="ccy">-</div></div>
      <div><div class="k">çªå‡ºç‰¹ç‚¹ï¼ˆç®€æ˜“ï¼‰</div><div class="v" id="feature">-</div></div>
    </div>
  </div>

  <div class="card">
    <h2>é™„è¿‘ 3 ä¸ªè‘—åæ™¯ç‚¹ï¼ˆå¯èƒ½ç¨æ…¢ï¼‰</h2>
    <ol>
      <li id="poi1">-</li>
      <li id="poi2">-</li>
      <li id="poi3">-</li>
    </ol>
    <div class="muted">è‹¥è¿™é‡Œä¸€ç›´æ˜¯â€œ-â€ï¼Œé€šå¸¸æ˜¯ Overpass æš‚æ—¶é™æµ/æ…¢ï¼Œç¨åå†è¯•ã€‚</div>
  </div>

<script>
  // ---- å…¬å¼€ API ç«¯ç‚¹ ----
  const WD_API = "https://www.wikidata.org/w/api.php";
  const WP_REST_SEARCH = "https://en.wikipedia.org/w/rest.php/v1/search/page";
  const OVERPASS = "https://overpass-api.de/api/interpreter";

  // â€œé™„è¿‘æ™¯ç‚¹â€æœç´¢åŠå¾„ï¼ˆç±³ï¼‰
  const POI_RADIUS_M = 7000;

  // Wikidata Property IDs
  const P = {
    INSTANCE_OF: "P31",
    COUNTRY: "P17",
    LOCATED_IN_ADMIN: "P131",
    COORD: "P625",
    POP: "P1082",
    AREA: "P2046",
    CURRENCY: "P38",
  };

  // ---- UI helpers ----
  function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }
  function setText(id, v) { document.getElementById(id).textContent = (v ?? "-"); }

  function toNumberMaybe(x) {
    // Wikidata æ•°é‡ç»å¸¸æ˜¯ {amount:"+12345", ...}
    if (x === null || x === undefined) return null;
    if (typeof x === "number") return x;
    if (typeof x === "string") {
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }
    if (typeof x === "object" && typeof x.amount === "string") {
      const n = Number(x.amount);
      return Number.isFinite(n) ? n : null;
    }
    return null;
  }

  function fmtNum(x) {
    const n = toNumberMaybe(x);
    if (n === null) return "-";
    return n.toLocaleString();
  }

  async function wdFetch(params) {
    const url = WD_API + "?" + new URLSearchParams({ ...params, format: "json", origin: "*" }).toString();
    const r = await fetch(url);
    if (!r.ok) throw new Error("Wikidata HTTP " + r.status);
    return r.json();
  }

  async function wdSearchEntity(query, lang="en") {
    const data = await wdFetch({
      action: "wbsearchentities",
      search: query,
      language: lang,
      limit: 1
    });
    return data?.search?.[0] || null;
  }

  async function wdGetEntity(qid) {
    const data = await wdFetch({
      action: "wbgetentities",
      ids: qid,
      props: "labels|descriptions|claims|sitelinks",
      languages: "en|fr"
    });
    return data?.entities?.[qid] || null;
  }

  function getFirstClaim(entity, prop) {
    const arr = entity?.claims?.[prop];
    if (!arr || !arr.length) return null;
    return arr[0]?.mainsnak?.datavalue?.value ?? null;
  }

  function getEntityIdFromValue(v) {
    return v?.id || null; // { id:"Qxxx" }
  }

  function getCoord(v) {
    if (!v || typeof v.latitude !== "number" || typeof v.longitude !== "number") return null;
    return { lat: v.latitude, lon: v.longitude };
  }

  async function qidToLabel(qid, lang="en") {
    if (!qid) return null;
    const ent = await wdGetEntity(qid);
    return ent?.labels?.[lang]?.value || ent?.labels?.en?.value || qid;
  }

  function pickTypeLabelFromInstanceOf(instanceLabel) {
    const s = (instanceLabel || "").toLowerCase();
    if (s.includes("sovereign state") || s === "country") return "å›½å®¶";
    if (s.includes("city") || s.includes("town")) return "åŸå¸‚";
    if (s.includes("capital")) return "é¦–éƒ½/é¦–åºœ";
    if (s.includes("region") || s.includes("province") || s.includes("state")) return "åœ°åŒº/è¡Œæ”¿åŒº";
    if (s.includes("tourist attraction") || s.includes("monument") || s.includes("museum") || s.includes("building")) return "æ™¯ç‚¹";
    return instanceLabel || "ï¼ˆæœªè¯†åˆ«ç±»å‹ï¼‰";
  }

  async function wpSearchSummary(query) {
    const url = WP_REST_SEARCH + "?" + new URLSearchParams({ q: query, limit: "1" }).toString();
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    const page = j?.pages?.[0];
    if (!page) return null;
    return {
      title: page.title,
      description: page.description || "",
      excerpt: (page.excerpt || "").replace(/<[^>]+>/g, "")
    };
  }

  async function fetchNearbyAttractions(lat, lon) {
    const q = `
      [out:json][timeout:25];
      (
        node(around:${POI_RADIUS_M},${lat},${lon})["tourism"="attraction"];
        node(around:${POI_RADIUS_M},${lat},${lon})["tourism"="museum"];
        node(around:${POI_RADIUS_M},${lat},${lon})["tourism"="viewpoint"];
        node(around:${POI_RADIUS_M},${lat},${lon})["historic"="monument"];
      );
      out tags 30;
    `;
    const r = await fetch(OVERPASS, { method: "POST", body: q, headers: { "Content-Type": "text/plain" } });
    if (!r.ok) return [];
    const j = await r.json();
    const els = j?.elements || [];
    const names = els.map(e => e?.tags?.name).filter(Boolean);

    const uniq = [];
    for (const n of names) {
      if (!uniq.includes(n)) uniq.push(n);
      if (uniq.length >= 3) break;
    }
    return uniq;
  }

  async function lookup() {
    const query = document.getElementById("q").value.trim();
    if (!query) { alert("è¯·è¾“å…¥å›½å®¶/åŸå¸‚/æ™¯ç‚¹åç§°"); return; }

    setStatus("æŸ¥è¯¢ä¸­â€¦");
    ["en","fr","type","desc","country","admin","where","coord","pop","area","ccy","feature","poi1","poi2","poi3"]
      .forEach(id => setText(id, "-"));

    try {
      const hit = await wdSearchEntity(query, "en");
      if (!hit?.id) { setStatus("æœªåœ¨ Wikidata æ‰¾åˆ°åŒ¹é…æ¡ç›®"); return; }

      const qid = hit.id;
      const entity = await wdGetEntity(qid);

      // labels
      const enLabel = entity?.labels?.en?.value || hit.label || query;
      const frLabel = entity?.labels?.fr?.value || "-";
      setText("en", enLabel);
      setText("fr", frLabel);

      // instance-of/type
      const instVal = getFirstClaim(entity, P.INSTANCE_OF);
      const instQid = getEntityIdFromValue(instVal);
      const instLabel = instQid ? await qidToLabel(instQid, "en") : null;
      setText("type", pickTypeLabelFromInstanceOf(instLabel));

      // country
      const countryVal = getFirstClaim(entity, P.COUNTRY);
      const countryQid = getEntityIdFromValue(countryVal);
      const countryLabel = countryQid ? await qidToLabel(countryQid, "en") : "-";
      setText("country", countryLabel);

      // admin
      const adminVal = getFirstClaim(entity, P.LOCATED_IN_ADMIN);
      const adminQid = getEntityIdFromValue(adminVal);
      const adminLabel = adminQid ? await qidToLabel(adminQid, "en") : "-";
      setText("admin", adminLabel);

      // coord
      const coordVal = getFirstClaim(entity, P.COORD);
      const coord = getCoord(coordVal);
      if (coord) setText("coord", `${coord.lat.toFixed(4)}, ${coord.lon.toFixed(4)}`);

      // pop / area / currency
      const popVal = getFirstClaim(entity, P.POP);
      const areaVal = getFirstClaim(entity, P.AREA);
      const curVal = getFirstClaim(entity, P.CURRENCY);
      const curQid = getEntityIdFromValue(curVal);
      const curLabel = curQid ? await qidToLabel(curQid, "en") : "-";

      setText("pop", fmtNum(popVal));
      setText("area", fmtNum(areaVal));
      setText("ccy", curLabel);

      // wikipedia summary
      const wp = await wpSearchSummary(enLabel);
      const summary = (wp?.description || wp?.excerpt || "").trim();
      setText("desc", summary || (entity?.descriptions?.en?.value ?? "-"));

      // where
      if (countryLabel !== "-" && adminLabel !== "-") setText("where", `ä½äº ${countryLabel}ï¼ˆ${adminLabel}ï¼‰`);
      else if (countryLabel !== "-") setText("where", `ä½äº ${countryLabel}`);
      else setText("where", "-");

      // feature (very simple heuristic)
      const d = (entity?.descriptions?.en?.value || "").toLowerCase();
      let feat = "-";
      if (d.includes("capital")) feat = "æ”¿æ²»/è¡Œæ”¿ä¸­å¿ƒ";
      else if (d.includes("tourist") || d.includes("attraction")) feat = "æ—…æ¸¸";
      else if (d.includes("financial") || d.includes("finance")) feat = "é‡‘è";
      else if (d.includes("agric")) feat = "å†œä¸š";
      else if (d.includes("industrial") || d.includes("manufact")) feat = "å·¥ä¸š";
      setText("feature", feat);

      // nearby POIs
      if (coord) {
        setStatus("æŸ¥è¯¢ä¸­â€¦ï¼ˆæ­£åœ¨æ‰¾é™„è¿‘æ™¯ç‚¹ï¼‰");
        const pois = await fetchNearbyAttractions(coord.lat, coord.lon);
        setText("poi1", pois[0] || "-");
        setText("poi2", pois[1] || "-");
        setText("poi3", pois[2] || "-");
      }

      setStatus("å®Œæˆ âœ…");
    } catch (e) {
      setStatus("æŸ¥è¯¢å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæˆ– API æš‚æ—¶ä¸å¯ç”¨ï¼‰ï¼Œè¯·ç¨åé‡è¯•ã€‚");
    }
  }
</script>

</body>
</html>
